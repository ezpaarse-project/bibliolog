# BiblioLog

BiblioLog is a tool for real-time viewing in the browser raw logs generated by your proxy (eg EZproxy) and usage events generated by [ezPAARSE](https://github.com/ezpaarse-project/ezpaarse).

It uses
  * [Log.io](http://logio.org/) for logs harvesting and for real-time viewing in the browser raw logs and usage events.
  * [ezpaarse2log.io](https://github.com/ezpaarse-project/ezpaarse2log.io) for real-time listening lines of log comming from log.io-harvester, creating ezPAARSE jobs to generate corresponding usage event and then sending all of this to log.oi-server

<p align="center">
<img src="https://docs.google.com/drawings/d/1wx-IudPtbiFurr8FMr84JOEKgfoTSC7DffOu6Ev6RAk/pub?w=828&amp;h=350" />
</p>

## Prerequisites

  * 2 serveurs with Linux OS (ex: debian or ubuntu)
    * 1st server hosts ezproxy daemons and especialy your ezproxy raw log files (server ip or hostname is: **{ezproxy-server}**)
    * 2nd server hosts bibliolog (server ip or hostname is: **{bibliolog-server}**)
  * Install curl and git on **{bibliolog-server}** and **{ezproxy-server}**:
```bash
sudo apt-get install curl git
```
  * Install NodeJS on **{bibliolog-server}** and **{ezproxy-server}**:
```bash
curl https://raw.githubusercontent.com/creationix/nvm/v0.5.1/install.sh | sh
nvm install 0.10
nvm use 0.10
nvm alias default 0.10
```
  * Install Log.io as a global command on **{bibliolog-server}** and **{ezproxy-server}** :
```bash
npm install -g log.io@0.3.2
```
  * Install ezpaarse on **{bibliolog-server}** and run it :
```bash
git clone https://github.com/ezpaarse-project/ezpaarse.git
cd ezpaarse/
git checkout `git describe --tags --abbrev=0`
make
make start
```

## Installation

On **{bibliolog-server}**:
```bash
git clone git@github.com:ezpaarse-project/bibliolog.git
cd bibliolog/
npm install -g forever

git clone git@github.com:ezpaarse-project/ezpaarse2log.io.git
cd ezpaarse2log.io/
npm install
```


## Configuration

### ezpaarse2log.io

On **{bibliolog-server}**:
```bash
cd ezpaarse2log.io/
echo "module.exports = {
  debug: false,
  ezpaarse: 'http://127.0.0.1:59599', // adjust if ezpaarse is installed elsewhere
  logio: {
    // listen for harvested logs
    listen: {
      host: '{bibliolog-server}',
      port: 28777         // this is the default log.io-harvester destination port
    },
    // broadcast to logio server daemon
    broadcast: {
      host: '{bibliolog-server}',
      port: 28778         // port choosen by bibliolog where to broadcast harvested logs + ezpaarse usage events
    }
  },
  autoConnectDelay: 1000, // time to wait beetween each connection try
};" > ./config.local.js
```

### log.io-harvester (raw log server side)

You have to configure ``log.io-harvester`` on **{ezproxy-server}** in order to:
  - listen for your ezproxy(s) log file
  - send data to the **{bibliolog-server}** (port 28777)

Here is a config file example which should be located at ``~/.log.io/harvester.conf``
```javascript
exports.config = {                                                                                      
  nodeName: "bibliolog",                                                                                
  logStreams: {                                                                                         
    bibliovie:      [ "/ezproxyvie/ezproxy.log" ],                    
    biblioplanets:  [ "/ezproxypla/ezproxy.log" ],                    
    biblioshs:      [ "/ezproxyshs/ezproxy.log" ],                    
    titanesciences: [ "/ezproxychim/ezproxy.log" ],
    bibliost2i:     [ "/ezproxyst2i/ezproxy.log" ],
    bibliosciences: [ "/ezproxybbs/ezproxy.log" ],
    biblioinserm:   [ "/ezproxyinserm/ezproxy.log" ],
    archivesiop:    [ "/ezproxyiop/ezproxy.log" ]
  },
  server: {
    host: '{bibliolog-server}',
    port: 28777
  }
}
```

### log.io-server (bibliolog side)

On **{bibliolog-server}**, tells to ``log.io-server`` where to listen for bibliolog raw logs + ezpaarse usage events:

```bash
echo "exports.config = {
  host: '0.0.0.0',
  port: 28778
}" > ~/.log.io/log_server.conf
```

Then configure your ``~/.log.io/web_server.conf`` as you want. This config file tells where the Web interface should listen and if it should be password protected or not.
Config file example:
```javascript
exports.config = {
  host: '0.0.0.0',
  port: 50196,

  // Enable HTTP Basic Authentication
  auth: {
    user: "BIBLIOLOG",
    pass: "XXXX"
  },
}
```

Then open your browser and go to http://bibliolog-ip:50196/ and you will have the nice bibliolog interface displayed.

![Running bibliolog screenshot](https://raw.githubusercontent.com/ezpaarse-project/bibliolog/master/bibliolog.png)

## Running BiblioLog

### Start

```bash
./etc/init.d/bibliolog start
```

### Status

```bash
./etc/init.d/bibliolog status
```

### Stop

```bash
./etc/init.d/bibliolog stop
```

### Log files

```bash
tail -f ./logs/ezpaarse2log.io-stderr.log
tail -f ./logs/ezpaarse2log.io-stdout.log
tail -f ./logs/log.io-server-stderr.log
tail -f ./logs/llog.io-server-stdout.log
```
